name: Build Besmi Native Android App

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install Dependencies
      run: |
        npm install
        npm install -g @capacitor/cli
        npm install -D typescript
    
    - name: Prepare Web Directory
      run: |
        mkdir -p www
        cp index.html www/
        rm -f capacitor.config.ts capacitor.config.js
    
    - name: Initialize Capacitor
      run: npx cap init "Besmi" "com.besmi.lashbooking" --web-dir="www"
    
    - name: Add Android Platform
      run: npx cap add android
    
    - name: Setup Android Icons and Resources
      run: |
        # Create directories
        mkdir -p android/app/src/main/res/drawable
        mkdir -p android/app/src/main/res/values
        
        # Create colors.xml (without ic_launcher_background to avoid duplicate)
        cat > android/app/src/main/res/values/colors.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="colorPrimary">#000000</color>
            <color name="colorPrimaryDark">#000000</color>
            <color name="colorAccent">#FF69B4</color>
        </resources>
        EOF
        
        # Create icon background
        cat > android/app/src/main/res/drawable/ic_launcher_background.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <vector xmlns:android="http://schemas.android.com/apk/res/android"
            android:width="108dp"
            android:height="108dp"
            android:viewportWidth="108"
            android:viewportHeight="108">
            
            <path
                android:fillColor="#000000"
                android:pathData="M0,0h108v108h-108z"/>
                
        </vector>
        EOF
        
        # Create icon foreground (Besmi "B" logo)
        cat > android/app/src/main/res/drawable/ic_launcher_foreground.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <vector xmlns:android="http://schemas.android.com/apk/res/android"
            android:width="108dp"
            android:height="108dp"
            android:viewportWidth="108"
            android:viewportHeight="108">
            
            <path
                android:fillColor="#FFFFFF"
                android:pathData="M25,20h25c10,0 18,4 18,13c0,5 -3,9 -8,11c6,2 10,7 10,13c0,10 -9,15 -20,15h-25v-52z
                                 M35,30v12h12c4,0 7,-2 7,-6c0,-4 -3,-6 -7,-6h-12z
                                 M35,50v14h15c5,0 8,-3 8,-7c0,-4 -3,-7 -8,-7h-15z"/>
                                 
        </vector>
        EOF
    
    - name: Copy Web Assets
      run: npx cap copy android
    
    - name: Sync Capacitor
      run: npx cap sync android
    
    - name: Build Android APK
      run: |
        cd android
        ./gradlew assembleDebug
    
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: besmi-mobile-app-with-sso-and-icons
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        if-no-files-found: error
